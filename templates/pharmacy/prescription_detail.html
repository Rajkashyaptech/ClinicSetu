{% extends "base/base.html" %}
{% block title %}Prescription | ClinicSetu{% endblock %}

{% block content %}
{% csrf_token %}

<h4 class="mb-3">Prescription</h4>

<div class="card mb-3">
  <div class="card-body">
    <strong>Patient:</strong> {{ prescription.visit.patient.full_name }}<br>
    <strong>Doctor:</strong> {{ prescription.visit.doctor.username }}<br>
    <strong>Date:</strong> {{ prescription.created_at|date:"d M Y" }}
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <h6>Medicines</h6>
    <ul>
      {% for item in prescription.items.all %}
        {% if item.status == "active" %}
          <li>
            {{ item.medicine_name }} â€”
            {{ item.dosage }},
            {{ item.frequency }},
            {{ item.duration }}
          </li>
        {% endif %}
      {% endfor %}
    </ul>
  </div>
</div>

<div class="d-flex gap-2">
  <button class="btn btn-outline-secondary" onclick="window.print()">
    Print
  </button>

<button
  id="dispenseBtn"
  class="btn btn-success"
  {% if not can_dispense %}
    disabled
  {% endif %}
>
  Mark as Dispensed
</button>

{% if not can_dispense %}
  <small class="text-muted d-block mt-1">
    Waiting for doctor to complete consultation
  </small>
{% endif %}


</div>
{% endblock %}


{% block extra_js %}
<script>
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

const dispenseBtn = document.getElementById("dispenseBtn");

if (dispenseBtn && !dispenseBtn.disabled) {
  dispenseBtn.addEventListener("click", function () {
    fetch("/api/v1/pharmacy/dispense/{{ prescription.id }}/", {
      method: "POST",
      headers: {
        "X-CSRFToken": csrftoken
      }
    })
    .then(async res => {
      const data = await res.json();
      if (!res.ok) {
        throw data;
      }
      return data;
    })
    .then(() => {
      alert("Medicines marked as dispensed");
      window.location.href = "/pharmacy/";
    })
    .catch(err => {
      alert(err.detail || "Unable to dispense medicines");
    });
  });
}
</script>
{% endblock %}
