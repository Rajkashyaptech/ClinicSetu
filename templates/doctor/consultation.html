{% extends "base/base.html" %}
{% block title %}Consultation | ClinicSetu{% endblock %}

{% block content %}

<h4 class="mb-3">Consultation</h4>

<!-- PATIENT INFO -->
<div class="card mb-3">
  <div class="card-body">
    <strong>Patient:</strong> {{ session.visit.patient.full_name }}<br>
    <strong>Age:</strong> {{ session.visit.patient.age|default:"-" }} |
    <strong>Gender:</strong> {{ session.visit.patient.gender|default:"-" }}
  </div>
</div>

<!-- VITALS -->
<div class="card mb-3">
  <div class="card-body">
    <h6>Vitals</h6>

    {% if session.visit.vitals %}
      {% with v=session.visit.vitals %}
        <div>Height: {{ v.height_cm|default:"-" }} cm</div>
        <div>Weight: {{ v.weight_kg|default:"-" }} kg</div>
        <div>Pulse: {{ v.pulse_rate|default:"-" }}</div>
      {% endwith %}
    {% else %}
      <p class="text-muted">Vitals not recorded</p>
    {% endif %}
  </div>
</div>

<!-- CURRENT MEDICINES -->
<div class="card mb-3">
  <div class="card-body">
    <h6>Current Medicines</h6>
    <ul id="medicineList" class="list-group mb-3">
      <li class="list-group-item text-muted">
        Loading medicines…
      </li>
    </ul>
  </div>
</div>

<!-- PRESCRIPTION -->
<div class="card mb-3">
  <div class="card-body">
    <h6>Add Medicine</h6>

    <form id="medicineForm" onsubmit="addMedicine(event)">
      {% csrf_token %}
      <input type="hidden" id="prescriptionId" value="{{ session.visit.prescription.id }}">
      <input type="hidden" id="sessionId" value="{{ session.id }}">

      <div class="row">
        <div class="col-md-3">
          <input class="form-control" placeholder="Medicine" id="medicine" required>
        </div>
        <div class="col-md-3">
          <input class="form-control" placeholder="Dosage" id="dosage" required>
        </div>
        <div class="col-md-3">
          <input class="form-control" placeholder="Frequency" id="frequency" required>
        </div>
        <div class="col-md-3">
          <input class="form-control" placeholder="Duration" id="duration" required>
        </div>
      </div>

      <button type="submit" class="btn btn-success mt-3">
        Add
      </button>

    </form>
  </div>
</div>

<!-- COMPLETE SESSION -->
<div class="text-end">
  <a href="{% url 'complete_consultation' session.id %}"
     class="btn btn-danger">
    Complete Session
  </a>
</div>
{% endblock %}


{% block extra_js %}
<script>
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
const prescriptionId = document.getElementById("prescriptionId").value;

/* LOAD MEDICINES */
function loadMedicines() {
  fetch(`/api/v1/prescriptions/active/?prescription_id=${prescriptionId}`)
    .then(res => res.json())
    .then(data => {
      const list = document.getElementById("medicineList");
      list.innerHTML = "";

      if (!data.length) {
        list.innerHTML = `
          <li class="list-group-item text-muted">
            No medicines added yet
          </li>`;
        return;
      }

      data.forEach(m => {
        list.innerHTML += `
          <li class="list-group-item">
            <strong>${m.medicine_name}</strong>
            — ${m.dosage}, ${m.frequency}, ${m.duration}
          </li>`;
      });
    })
    .catch(() => {
      document.getElementById("medicineList").innerHTML =
        `<li class="list-group-item text-danger">
          Failed to load medicines
        </li>`;
    });
}

/* ADD MEDICINE */
function addMedicine(event) {
  event.preventDefault();

  fetch("/api/v1/prescriptions/add-medicine/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": csrftoken
    },
    body: JSON.stringify({
      prescription_id: document.getElementById("prescriptionId").value,
      session_id: document.getElementById("sessionId").value,
      medicine: document.getElementById("medicine").value,
      dosage: document.getElementById("dosage").value,
      frequency: document.getElementById("frequency").value,
      duration: document.getElementById("duration").value
    })
  })
  .then(res => {
    if (!res.ok) throw new Error("Failed to add medicine");
    return res.json();
  })
  .then(() => {
    document.getElementById("medicineForm").reset();
    loadMedicines();
  })
  .catch(err => alert(err.message));
}

/* INIT */
loadMedicines();
</script>
{% endblock %}
