{% extends "base/base.html" %}
{% block content %}
<h4>Staff Management</h4>

<div id="quota" class="mb-3 fw-semibold"></div>

<table class="table table-bordered">
  <thead>
    <tr>
      <th>Username</th>
      <th>Role</th>
      <th>Status</th>
      <th width="220">Actions</th>
    </tr>
  </thead>
  <tbody id="staffTable"></tbody>
</table>

<hr>

<h5>Add Staff</h5>
<form id="addStaffForm">
  {% csrf_token %}
  <input class="form-control mb-2" placeholder="Username" id="username" required>
  <input class="form-control mb-2" placeholder="Password" id="password" required>

  <select class="form-select mb-2" id="role">
    <option value="doctor">Doctor</option>
    <option value="receptionist">Receptionist</option>
    <option value="medical_staff">Medical Staff</option>
  </select>

  <button class="btn btn-primary">Create</button>
</form>

<!-- EDIT MODAL -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Edit Staff</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="editUserId">

        <div class="mb-3">
          <label class="form-label">Username</label>
          <input class="form-control" id="editUsername">
        </div>

        <div class="mb-3">
          <label class="form-label">New Password (optional)</label>
          <input type="password" class="form-control" id="editPassword">
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" onclick="saveEdit()">Save</button>
      </div>

    </div>
  </div>
</div>

<a href="{% url 'audit_logs' %}" class="btn btn-outline-secondary btn-sm">
  View Audit Logs
</a>

{% endblock %}

{% block extra_js %}
<script>
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
let editModal = new bootstrap.Modal(document.getElementById("editModal"));

/* LOAD STAFF */
function loadStaff() {
  fetch("/api/v1/accounts/staff/")
    .then(res => res.json())
    .then(data => {

      document.getElementById("quota").innerText =
        `Doctors ${data.usage.doctors}/${data.limits.doctors},
         Receptionists ${data.usage.receptionists}/${data.limits.receptionists},
         Medical ${data.usage.medical_staff}/${data.limits.medical_staff}`;

      const tbody = document.getElementById("staffTable");
      tbody.innerHTML = "";

      data.staff.forEach(u => {
        tbody.innerHTML += `
          <tr>
            <td>${u.username}</td>
            <td>${u.role}</td>
            <td>${u.is_active ? "Active" : "Inactive"}</td>
            <td>
              <button class="btn btn-sm ${u.is_active ? "btn-danger" : "btn-success"}"
                onclick="toggleStatus(${u.id}, ${!u.is_active})">
                ${u.is_active ? "Deactivate" : "Reactivate"}
              </button>

              <button class="btn btn-sm btn-outline-secondary ms-2"
                onclick="openEditModal(${u.id}, '${u.username}')">
                Edit
              </button>
            </td>
          </tr>
        `;
      });
    });
}

/* TOGGLE ACTIVE / INACTIVE */
function toggleStatus(userId, status) {
  fetch(`/api/v1/accounts/staff/status/${userId}/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": csrftoken
    },
    body: JSON.stringify({ is_active: status })
  }).then(loadStaff);
}

/* OPEN EDIT MODAL */
function openEditModal(userId, username) {
  document.getElementById("editUserId").value = userId;
  document.getElementById("editUsername").value = username;
  document.getElementById("editPassword").value = "";
  editModal.show();
}

/* SAVE EDIT */
function saveEdit() {
  const userId = document.getElementById("editUserId").value;

  fetch(`/api/v1/accounts/staff/update/${userId}/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": csrftoken
    },
    body: JSON.stringify({
      username: document.getElementById("editUsername").value,
      password: document.getElementById("editPassword").value
    })
  }).then(() => {
    editModal.hide();
    loadStaff();
  });
}

/* CREATE STAFF */
document.getElementById("addStaffForm").addEventListener("submit", e => {
  e.preventDefault();

  fetch("/api/v1/accounts/staff/create/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": csrftoken
    },
    body: JSON.stringify({
      username: username.value,
      password: password.value,
      role: role.value
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) {
      alert(data.error);
    } else {
      document.getElementById("addStaffForm").reset();
      loadStaff();
    }
  });
});

/* INITIAL LOAD */
loadStaff();
</script>
{% endblock %}
